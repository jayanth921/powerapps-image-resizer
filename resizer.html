<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Power Apps Image Resizer & Uploader</title>
</head>
<body>
  <script>
    // Listen for messages from Power Apps
    window.addEventListener("message", async function (event) {
      const { imageBase64, fileName, roomKey } = event.data || {};
      if (!imageBase64 || !fileName || !roomKey) {
        sendStatusToPowerApps({
          fileName,
          status: "❌ Missing data for upload.",
          success: false
        });
        return;
      }

      try {
        // Resize if needed
        const resizedBlob = await resizeImage(imageBase64);

        if (!resizedBlob) {
          sendStatusToPowerApps({
            fileName,
            status: `❌ Resize failed for ${fileName} (> 2MB)`,
            success: false
          });
          return;
        }

        // Prepare form data for upload
        const formData = new FormData();
        formData.append("file", resizedBlob, fileName);
        formData.append("roomKey", roomKey);

        // Upload to API
        const response = await fetch("https://your-api-endpoint/upload", {
          method: "POST",
          body: formData
        });

        if (response.ok) {
          sendStatusToPowerApps({
            fileName,
            status: `✅ ${fileName} uploaded successfully for room key: ${roomKey}`,
            success: true
          });
        } else {
          sendStatusToPowerApps({
            fileName,
            status: `❌ Upload failed for ${fileName} (HTTP ${response.status})`,
            success: false
          });
        }
      } catch (err) {
        console.error(err);
        sendStatusToPowerApps({
          fileName,
          status: `❌ Error uploading ${fileName}`,
          success: false
        });
      }
    });

    // Function to resize an image if over 2MB
    async function resizeImage(base64Str) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = async () => {
          let width = img.width;
          let height = img.height;
          const maxSize = 1024;

          // Scale down dimensions if needed
          if (width > maxSize || height > maxSize) {
            if (width > height) {
              height = height * (maxSize / width);
              width = maxSize;
            } else {
              width = width * (maxSize / height);
              height = maxSize;
            }
          }

          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);

          let quality = 0.9;
          let blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', quality));

          // Reduce quality until <= 2MB
          while (blob.size > 2 * 1024 * 1024 && quality > 0.1) {
            quality -= 0.1;
            blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', quality));
          }

          resolve(blob.size <= 2 * 1024 * 1024 ? blob : null);
        };
        img.src = base64Str;
      });
    }

    // Send status back to Power Apps
    function sendStatusToPowerApps(messageObj) {
      window.parent.postMessage(messageObj, "*");
    }
  </script>
</body>
</html>
