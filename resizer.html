<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Image Resizer</title>
</head>
<body>
<script>
window.addEventListener("message", async (event) => {
    if (!event.data || !event.data.images) return;

    const processedImages = [];

    for (let imgData of event.data.images) {
        const base64 = imgData.base64;
        const fileName = imgData.name;

        // Convert base64 to Blob
        const blob = base64ToBlob(base64);
        
        // If >2MB, resize
        if (blob.size > 2 * 1024 * 1024) {
            const resizedBase64 = await resizeImage(base64, fileName);
            processedImages.push({ name: fileName, base64: resizedBase64 });
        } else {
            processedImages.push({ name: fileName, base64: base64 });
        }
    }

    // Send processed images back to Power Apps
    window.parent.postMessage({ processedImages }, "*");
});

function base64ToBlob(base64) {
    const byteString = atob(base64.split(',')[1]);
    const mimeString = base64.split(',')[0].split(':')[1].split(';')[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab], { type: mimeString });
}

function resizeImage(base64Str, fileName) {
    return new Promise((resolve) => {
        const img = new Image();
        img.src = base64Str;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            let width = img.width;
            let height = img.height;

            // Keep aspect ratio, shrink dimensions until < 2MB
            let quality = 0.9;
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);

            let result = canvas.toDataURL('image/jpeg', quality);
            let resultBlob = base64ToBlob(result);

            while (resultBlob.size > 2 * 1024 * 1024 && quality > 0.1) {
                quality -= 0.05;
                result = canvas.toDataURL('image/jpeg', quality);
                resultBlob = base64ToBlob(result);
            }
            resolve(result);
        };
    });
}
</script>
</body>
</html>
