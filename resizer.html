<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Resizer</title>
</head>
<body style="font-family: Arial, sans-serif; padding: 10px;">
    <h2>Image Resizer</h2>
    <div id="status">Waiting for image...</div>

    <script>
        // --- Configurable Settings ---
        const MAX_WIDTH = 1024;  // Max width after resize
        const MAX_HEIGHT = 1024; // Max height after resize
        const API_UPLOAD_URL = "https://your-api-endpoint.com/upload"; // Replace with your API URL

        // Receive message from Power Apps
        window.addEventListener("message", async (event) => {
            try {
                const base64Image = event.data; 
                if (!base64Image.startsWith("data:image")) {
                    document.getElementById("status").innerText = "Invalid image data received.";
                    return;
                }

                document.getElementById("status").innerText = "Resizing image...";

                const resizedBlob = await resizeBase64Image(base64Image, MAX_WIDTH, MAX_HEIGHT);

                document.getElementById("status").innerText = "Uploading image...";
                const uploadResult = await uploadImage(resizedBlob);

                document.getElementById("status").innerText = "Upload successful!";
                
                // Send success message back to Power Apps
                window.parent.postMessage({ success: true, result: uploadResult }, "*");

            } catch (err) {
                document.getElementById("status").innerText = "Error: " + err.message;
                window.parent.postMessage({ success: false, error: err.message }, "*");
            }
        });

        function resizeBase64Image(base64Str, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;

                    // Maintain aspect ratio
                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    // Create canvas for resizing
                    const canvas = document.createElement("canvas");
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert canvas to Blob
                    canvas.toBlob((blob) => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error("Canvas blob conversion failed."));
                        }
                    }, "image/jpeg", 0.85); // Adjust quality if needed
                };
                img.onerror = () => reject(new Error("Failed to load image."));
                img.src = base64Str;
            });
        }

        async function uploadImage(imageBlob) {
            const formData = new FormData();
            formData.append("file", imageBlob, "resized-image.jpg");

            const response = await fetch(API_UPLOAD_URL, {
                method: "POST",
                body: formData
            });

            if (!response.ok) {
                throw new Error("Upload failed with status " + response.status);
            }

            return await response.json();
        }
    </script>
</body>
</html>
