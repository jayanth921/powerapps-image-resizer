<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Power Apps Image Resizer</title>
</head>
<body>
  <h3>Image Upload Status</h3>
  <div id="status">Waiting for image...</div>

  <script>
    window.addEventListener("message", async function (event) {
      const imageBase64 = event.data?.imageBase64;
      if (!imageBase64) return;

      document.getElementById("status").textContent = "Received image. Resizing...";

      const resizedBlob = await resizeImage(imageBase64);

      if (!resizedBlob) {
        document.getElementById("status").textContent = "Resize failed (> 2MB)";
        return;
      }

      const formData = new FormData();
      formData.append("file", resizedBlob, "resized.jpg");

      try {
        const response = await fetch("https://your-api-endpoint/upload", {
          method: "POST",
          body: formData
        });

        if (response.ok) {
          document.getElementById("status").textContent = "✅ Upload successful!";
        } else {
          document.getElementById("status").textContent = "❌ Upload failed: " + response.status;
        }
      } catch (e) {
        console.error(e);
        document.getElementById("status").textContent = "❌ Upload error!";
      }
    });

    async function resizeImage(base64Str) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = async () => {
          let width = img.width;
          let height = img.height;
          const maxSize = 1024;

          if (width > maxSize || height > maxSize) {
            if (width > height) {
              height = height * (maxSize / width);
              width = maxSize;
            } else {
              width = width * (maxSize / height);
              height = maxSize;
            }
          }

          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);

          let quality = 0.9;
          let blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', quality));

          while (blob.size > 2 * 1024 * 1024 && quality > 0.1) {
            quality -= 0.1;
            blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', quality));
          }

          resolve(blob.size <= 2 * 1024 * 1024 ? blob : null);
        };

        img.src = base64Str;
      });
    }
  </script>
</body>
</html>
